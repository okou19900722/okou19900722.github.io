{"pageProps":{"categories":["releases","guides","news"],"post":{"meta":{"title":"Easy SSO for Vert.x with Keycloak","category":"guides","authors":[{"name":"Thomas Darimont","github_id":"thomasdarimont"}],"summary":"In this blog post, you'll learn how to implement Single Sign-on with OpenID Connect and how to use Keycloak together with Eclipse Vert.x."},"date":"2020-03-16","slug":"easy-sso-for-vert-x-with-keycloak","readingTime":{"text":"11 min read","minutes":10.11,"time":606599.9999999999,"words":2022},"content":{"compiledSource":"\"use strict\";\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar layoutProps = {};\nvar MDXLayout = \"wrapper\";\n\nfunction MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"TL;DR:\")), mdx(\"p\", null, \"In this blog post you\\u2019ll learn:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to im\\xADple\\xADment Sin\\xADgle Sign-\\u200Bon with OpenID Con\\xADnect\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to use Key\\xADcloak\\u2019s OpenID Dis\\xADcov\\xADery to infer OpenID provider con\\xADfig\\xADu\\xADra\\xADtion\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to ob\\xADtain user in\\xADfor\\xADma\\xADtion\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to check for au\\xADtho\\xADriza\\xADtion\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to call a Bearer pro\\xADtected ser\\xADvice with an Ac\\xADcess Token\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to im\\xADple\\xADment a form based lo\\xADgout\")), mdx(\"h2\", {\n    \"id\": \"hello-blog\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#hello-blog\"\n  })), \"Hello Blog\"), mdx(\"p\", null, \"This is my first post in the Vert.x Blog and I must admit that up until now I have never used Vert.x in a real project.\\n\\u201CWhy are you here?\\u201D, you might ask\\u2026 Well I cur\\xADrently have two main hob\\xADbies, learn\\xADing new things and se\\xADcur\\xADing apps with \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.keycloak.org/\"\n  }), \"Key\\xADcloak\"), \".\\nSo a few days ago, I stum\\xADbled upon the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.youtube.com/watch?v=LsaXy7SRXMY&list=PLkeCJDaCC2ZsnySdg04Aq9D9FpAZY6K5D\"\n  }), \"In\\xADtro\\xADduc\\xADtion to Vert.x video se\\xADries on youtube\"), \" by \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://twitter.com/infosec812\"\n  }), \"Deven Phillips\"), \" and I was im\\xADme\\xADdi\\xADately hooked. Vert.x was a new thing for me, so the next log\\xADi\\xADcal step was to fig\\xADure out how to se\\xADcure a Vert.x app with Key\\xADcloak.\"), mdx(\"p\", null, \"For this ex\\xADam\\xADple I build a small web app with Vert.x that shows how to im\\xADple\\xADment Sin\\xADgle Sign-\\u200Bon (SSO) with Key\\xADcloak\\nand OpenID Con\\xADnect, ob\\xADtain in\\xADfor\\xADma\\xADtion about the cur\\xADrent user, check for roles, call bearer pro\\xADtected ser\\xADvices and prop\\xADerly han\\xADdling lo\\xADgout.\"), mdx(\"h2\", {\n    \"id\": \"keycloak\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#keycloak\"\n  })), \"Keycloak\"), mdx(\"p\", null, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.keycloak.org/\"\n  }), \"Key\\xADcloak\"), \" is a Open Source Iden\\xADtity and Ac\\xADcess Man\\xADage\\xADment so\\xADlu\\xADtion which pro\\xADvides sup\\xADport for OpenID Con\\xADnect\\nbased Singe-\\u200BSign on, among many other things. I briefly looked for ways to se\\xADcur\\xADing a Vert.x app with Key\\xADcloak\\nand quickly found an \", mdx(Link, {\n    href: \"/blog/vertx-3-and-keycloak-tutorial/\",\n    passHref: true,\n    mdxType: \"Link\"\n  }, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"\"\n  }), \"older Vert.x Key\\xADcloak in\\xADte\\xADgra\\xADtion ex\\xADam\\xADple\")), \" in this very blog.\\nWhilst this is a good start for be\\xADgin\\xADners, the ex\\xADam\\xADple con\\xADtains a few is\\xADsues, e.g.:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"It uses hard\\xADcoded OpenID provider con\\xADfig\\xADu\\xADra\\xADtion\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Fea\\xADtures a very sim\\xADplis\\xADtic in\\xADte\\xADgra\\xADtion (for the sake of sim\\xADplic\\xADity)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"No user in\\xADfor\\xADma\\xADtion used\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"No lo\\xADgout func\\xADtion\\xADal\\xADity is shown\")), mdx(\"p\", null, \"That some\\xADhow nerd\\xADsniped me a bit and so it came that, after a long day of con\\xADsult\\xADing work, I sat down to cre\\xADate an ex\\xADam\\xADple for a com\\xADplete Key\\xADcloak in\\xADte\\xADgra\\xADtion based on \", mdx(Link, {\n    href: \"/docs/vertx-auth-oauth2/java/\",\n    passHref: true,\n    mdxType: \"Link\"\n  }, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"\"\n  }), \"Vert.x OpenID Con\\xADnect / OAuth2 Sup\\xADport\")), \".\"), mdx(\"p\", null, \"So let\\u2019s get started!\"), mdx(\"h3\", {\n    \"id\": \"keycloak-setup\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#keycloak-setup\"\n  })), \"Keycloak Setup\"), mdx(\"p\", null, \"To se\\xADcure a Vert.x app with Key\\xADcloak we of course need a Key\\xADcloak in\\xADstance. Al\\xADthough \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.keycloak.org/docs/latest/getting_started/\"\n  }), \"Key\\xADcloak has a great get\\xADting started guide\"), \" I wanted to make it a bit eas\\xADier to put every\\xADthing to\\xADgether, there\\xADfore I pre\\xADpared a local Key\\xADcloak docker con\\xADtainer \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/thomasdarimont/vertx-playground/tree/master/keycloak-vertx#start-keycloak-with-the-vertx-realm\"\n  }), \"as de\\xADscribed here\"), \" that you can start eas\\xADily, which comes with all the re\\xADquired con\\xADfig\\xADu\\xADra\\xADtion in place.\"), mdx(\"p\", null, \"The pre\\xADcon\\xADfig\\xADured Key\\xADcloak realm named \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"vertx\"), \" con\\xADtains a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"demo-client\"), \" for our Vert.x web app and a set\\nof users for test\\xADing.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-haml\"\n  }), \"docker run \\\\\\n  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"it \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"-name vertx-keycloak \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"-rm \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"e KEYCLOAK_USER=admin \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"e KEYCLOAK_PASSWORD=admin \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"e KEYCLOAK_IMPORT=\", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-regexp\"\n  }), \"/tmp/vertx\"), \"-realm.json \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"v $PWD/vertx-realm.\", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-symbol\"\n  }), \"json:\"), \"/tmp/vertx-realm.json \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"p \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"8080\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-symbol\"\n  }), \":\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"8080\"), \" \\\\\\n\"), \"  quay.io/keycloak/keycloak:9.0.0\\n\")), mdx(\"h2\", {\n    \"id\": \"vertx-web-app\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#vertx-web-app\"\n  })), \"Vert.x Web App\"), mdx(\"p\", null, \"The sim\\xADple web app con\\xADsists of a sin\\xADgle \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Verticle\"), \", runs on \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http://localhost:8090\"), \" and pro\\xADvides a few routes with pro\\xADtected re\\xADsources. \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/thomasdarimont/vertx-playground/blob/master/keycloak-vertx/src/main/java/demo/MainVerticle.java\"\n  }), \"You can find the com\\xADplete ex\\xADam\\xADple here\"), \".\"), mdx(\"p\", null, \"The web app con\\xADtains the fol\\xADlow\\xADing routes with han\\xADdlers:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/\"), \" - The un\\xADpro\\xADtected index page\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/protected\"), \" - The pro\\xADtected page, which shows a greet\\xADing mes\\xADsage, users need to login to ac\\xADcess pages be\\xADneath this path.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/protected/user\"), \" - The pro\\xADtected user page, which shows some in\\xADfor\\xADma\\xADtion about the user.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/protected/admin\"), \" - The pro\\xADtected admin page, which shows some in\\xADfor\\xADma\\xADtion about the admin, only users with role \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"admin\"), \" can ac\\xADcess this page.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/protected/userinfo\"), \" - The pro\\xADtected user\\xADinfo page, ob\\xADtains user in\\xADfor\\xADma\\xADtion from the bearer token pro\\xADtected user\\xADinfo end\\xADpoint in Key\\xADcloak.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/logout\"), \" - The pro\\xADtected lo\\xADgout re\\xADsource, which trig\\xADgers the user lo\\xADgout.\")), mdx(\"h3\", {\n    \"id\": \"running-the-app\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#running-the-app\"\n  })), \"Running the app\"), mdx(\"p\", null, \"To run the app, we need to build our app via:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-bash\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-built_in\"\n  }), \"cd\"), \" keycloak-vertx\\nmvn clean package\\n\")), mdx(\"p\", null, \"This cre\\xADates a runnable jar, which we can run via:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-bash\"\n  }), \"java -jar target/*.jar\\n\")), mdx(\"p\", null, \"Note, that you need to start Key\\xADcloak, since our app will try to fetch con\\xADfig\\xADu\\xADra\\xADtion from Key\\xADcloak.\"), mdx(\"p\", null, \"If the ap\\xADpli\\xADca\\xADtion is run\\xADning, just browse to: \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http://localhost:8090/\"), \".\"), mdx(\"p\", null, \"An ex\\xADam\\xADple in\\xADter\\xADac\\xADtion with the app can be seen in the fol\\xADlow\\xADing gif:\"), mdx(\"p\", null, mdx(\"img\", _extends({\n    parentName: \"p\"\n  }, {\n    \"src\": \"/images/blog/vertx-keycloak-integration/2020-03-07-vertx-keycloak-integration.gif\",\n    \"alt\": \"Vert.x Keycloak Integration Demo\"\n  }))), mdx(\"h3\", {\n    \"id\": \"router-sessionstore-and-csrf-protection\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#router-sessionstore-and-csrf-protection\"\n  })), \"Router, SessionStore and CSRF Protection\"), mdx(\"p\", null, \"We start the con\\xADfig\\xADu\\xADra\\xADtion of our web app by cre\\xADat\\xADing a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Router\"), \" where we can add cus\\xADtom han\\xADdler func\\xADtions for our routes.\\nTo prop\\xADerly han\\xADdle the au\\xADthen\\xADti\\xADca\\xADtion state we need to cre\\xADate a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SessionStore\"), \" and at\\xADtach it to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Router\"), \".\\nThe \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SessionStore\"), \" is used by our OAuth2/OpenID Con\\xADnect in\\xADfra\\xADstruc\\xADture to as\\xADso\\xADciate au\\xADthen\\xADti\\xADca\\xADtion in\\xADfor\\xADma\\xADtion with a ses\\xADsion.\\nBy the way, the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SessionStore\"), \" can also be clus\\xADtered if you need to dis\\xADtrib\\xADute the server-\\u200Bside state.\"), mdx(\"p\", null, \"Note that if you want to keep your server state\\xADless but still want to sup\\xADport clus\\xADter\\xADing,\\nthen you could pro\\xADvide your own im\\xADple\\xADmen\\xADta\\xADtion of a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SessionStore\"), \" which stores the ses\\xADsion in\\xADfor\\xADma\\xADtion\\nas an en\\xADcrypted cookie on the Client.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), \"Router router = Router.router(vertx);\\n\\n\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// Store session information on the server side\"), \"\\nSessionStore sessionStore = LocalSessionStore.create(vertx);\\nSessionHandler sessionHandler = SessionHandler.create(sessionStore);\\nrouter.route().handler(sessionHandler);\\n\")), mdx(\"p\", null, \"In order to pro\\xADtected against CSRF at\\xADtacks it is good prac\\xADtice to pro\\xADtect HTML forms with a CSRF token.\\nWe need this for our lo\\xADgout form that we\\u2019ll see later.\"), mdx(\"p\", null, \"To do this we con\\xADfig\\xADure a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CSRFHandler\"), \" and add it to our \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Router\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// CSRF handler setup required for logout form\"), \"\\nString csrfSecret = \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"zwiebelfische\\\"\"), \";\\nCSRFHandler csrfHandler = CSRFHandler.create(csrfSecret);\\nrouter.route().handler(ctx -> {\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// Ensures that the csrf token request parameter is available for the CsrfHandler\"), \"\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// after the logout form was submitted.\"), \"\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// See \\\"Handling HTML forms\\\" https://vertx.io/docs/vertx-core/java/#_handling_requests\"), \"\\n            ctx.request().setExpectMultipart(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"true\"), \");\\n            ctx.request().endHandler(v -> csrfHandler.handle(ctx));\\n        }\\n);\\n\")), mdx(\"h3\", {\n    \"id\": \"keycloak-setup-via-openid-connect-discovery\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#keycloak-setup-via-openid-connect-discovery\"\n  })), \"Keycloak Setup via OpenID Connect Discovery\"), mdx(\"p\", null, \"Our app is reg\\xADis\\xADtered as a con\\xADfi\\xADden\\xADtial OpenID Con\\xADnect client with Au\\xADtho\\xADriza\\xADtion Code Flow in Key\\xADcloak,\\nthus we need to con\\xADfig\\xADure \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client_id\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client_secret\"), \". Con\\xADfi\\xADden\\xADtial clients are typ\\xADi\\xADcally used\\nfor server-\\u200Bside web ap\\xADpli\\xADca\\xADtions, where one can se\\xADcurely store the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client_secret\"), \". You can find out more\\nabout\", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.keycloak.org/docs/latest/server_admin/index.html#_access-type\"\n  }), \"The dif\\xADfer\\xADent Client Ac\\xADcess Types\"), \" in the Key\\xADcloak doc\\xADu\\xADmen\\xADta\\xADtion.\"), mdx(\"p\", null, \"Since we don\\u2019t want to con\\xADfig\\xADure things like OAuth2 / OpenID Con\\xADnect End\\xADpoints our\\xADselves, we use Key\\xADcloak\\u2019s OpenID Con\\xADnect dis\\xADcov\\xADery end\\xADpoint to infer the nec\\xADes\\xADsary Oauth2 / OpenID Con\\xADnect end\\xADpoint URLs.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), \"String hostname = System.getProperty(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"http.host\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"localhost\\\"\"), \");\\n\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"int\"), \" port = Integer.getInteger(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"http.port\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"8090\"), \");\\nString baseUrl = String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"http://%s:%d\\\"\"), \", hostname, port);\\nString oauthCallbackPath = \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/callback\\\"\"), \";\\n\\nOAuth2ClientOptions clientOptions = \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"new\"), \" OAuth2ClientOptions()\\n    .setFlow(OAuth2FlowType.AUTH_CODE)\\n    .setSite(System.getProperty(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"oauth2.issuer\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"http://localhost:8080/auth/realms/vertx\\\"\"), \"))\\n    .setClientID(System.getProperty(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"oauth2.client_id\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"demo-client\\\"\"), \"))\\n    .setClientSecret(System.getProperty(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"oauth2.client_secret\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"1f88bd14-7e7f-45e7-be27-d680da6e48d8\\\"\"), \"));\\n\\nKeycloakAuth.discover(vertx, clientOptions, asyncResult -> {\\n\\n    OAuth2Auth oauth2Auth = asyncResult.result();\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"if\"), \" (oauth2Auth == \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"null\"), \") {\\n        \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"throw\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"new\"), \" RuntimeException(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"Could not configure Keycloak integration via OpenID Connect Discovery Endpoint. Is Keycloak running?\\\"\"), \");\\n    }\\n\\n    AuthHandler oauth2 = OAuth2AuthHandler.create(oauth2Auth, baseUrl + oauthCallbackPath)\\n        .setupCallback(router.get(oauthCallbackPath))\\n        \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// Additional scopes: openid for OpenID Connect\"), \"\\n        .addAuthority(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"openid\\\"\"), \");\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// session handler needs access to the authenticated user, otherwise we get an infinite redirect loop\"), \"\\n    sessionHandler.setAuthProvider(oauth2Auth);\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// protect resources beneath /protected/* with oauth2 handler\"), \"\\n    router.route(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/protected/*\\\"\"), \").handler(oauth2);\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// configure route handlers\"), \"\\n    configureRoutes(router, webClient, oauth2Auth);\\n});\\n\\ngetVertx().createHttpServer().requestHandler(router).listen(port);\\n\")), mdx(\"h3\", {\n    \"id\": \"route-handlers\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#route-handlers\"\n  })), \"Route handlers\"), mdx(\"p\", null, \"We con\\xADfig\\xADure our route han\\xADdlers via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"configureRoutes\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"configureRoutes\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(Router router, WebClient webClient, OAuth2Auth oauth2Auth)\"), \" \"), \"{\\n\\n    router.get(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/\\\"\"), \").handler(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"this\"), \"::handleIndex);\\n\\n    router.get(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/protected\\\"\"), \").handler(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"this\"), \"::handleGreet);\\n    router.get(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/protected/user\\\"\"), \").handler(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"this\"), \"::handleUserPage);\\n    router.get(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/protected/admin\\\"\"), \").handler(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"this\"), \"::handleAdminPage);\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// extract discovered userinfo endpoint url\"), \"\\n    String userInfoUrl =  ((OAuth2AuthProviderImpl)oauth2Auth).getConfig().getUserInfoPath();\\n    router.get(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/protected/userinfo\\\"\"), \").handler(createUserInfoHandler(webClient, userInfoUrl));\\n\\n    router.post(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/logout\\\"\"), \").handler(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"this\"), \"::handleLogout);\\n}\\n\")), mdx(\"p\", null, \"The index han\\xADdler ex\\xADposes an un\\xADpro\\xADtected re\\xADsource:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"handleIndex\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n    respondWithOk(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<h1>Welcome to Vert.x Keycloak Example</h1><br><a href=\\\\\\\"/protected\\\\\\\">Protected</a>\\\"\"), \");\\n}\\n\")), mdx(\"h3\", {\n    \"id\": \"extract-user-information-from-the-openid-connect-id-token\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#extract-user-information-from-the-openid-connect-id-token\"\n  })), \"Extract User Information from the OpenID Connect ID Token\"), mdx(\"p\", null, \"Our app ex\\xADposes a sim\\xADple greet\\xADing page which shows some in\\xADfor\\xADma\\xADtion about the user and pro\\xADvides links to other pages.\"), mdx(\"p\", null, \"The user greet\\xADing han\\xADdler is pro\\xADtected by the Key\\xADcloak OAuth2 / OpenID Con\\xADnect in\\xADte\\xADgra\\xADtion. To show in\\xADfor\\xADma\\xADtion about\\nthe cur\\xADrent user, we first need to call the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ctx.user()\"), \" method to get an user ob\\xADject we can work with.\\nTo ac\\xADcess the OAuth2 token in\\xADfor\\xADma\\xADtion, we need to cast it to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"OAuth2TokenImpl\"), \".\"), mdx(\"p\", null, \"We can ex\\xADtract the user in\\xADfor\\xADma\\xADtion like the user\\xADname from the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"IDToken\"), \" ex\\xADposed by the user ob\\xADject via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"user.idToken().getString(\\\"preferred_username\\\")\"), \".\\nNote, there are many more claims like (name, email, give\\xADnanme, fam\\xADi\\xADly\\xADname etc.) avail\\xADable. The \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://openid.net/specs/openid-connect-core-1_0.html#Claims\"\n  }), \"OpenID Con\\xADnect Core Spec\\xADi\\xADfi\\xADca\\xADtion\"), \" con\\xADtains a list of avail\\xADable claims.\"), mdx(\"p\", null, \"We also gen\\xADer\\xADate a list with links to the other pages which are sup\\xADported:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"handleGreet\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n\\n    OAuth2TokenImpl oAuth2Token = (OAuth2TokenImpl) ctx.user();\\n\\n    String username = oAuth2Token.idToken().getString(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"preferred_username\\\"\"), \");\\n\\n    String greeting = String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<h1>Hi %s @%s</h1><ul>\\\"\"), \" +\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<li><a href=\\\\\\\"/protected/user\\\\\\\">User Area</a></li>\\\"\"), \" +\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<li><a href=\\\\\\\"/protected/admin\\\\\\\">Admin Area</a></li>\\\"\"), \" +\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<li><a href=\\\\\\\"/protected/userinfo\\\\\\\">User Info (Remote Call)</a></li>\\\"\"), \" +\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"</ul>\\\"\"), \", username, Instant.now());\\n\\n    String logoutForm = createLogoutForm(ctx);\\n\\n    respondWithOk(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", greeting + logoutForm);\\n}\\n\")), mdx(\"p\", null, \"The user page han\\xADdler shows in\\xADfor\\xADma\\xADtion about the cur\\xADrent user:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"handleUserPage\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n\\n    OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\\n\\n    String username = user.idToken().getString(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"preferred_username\\\"\"), \");\\n    String displayName = oAuth2Token.idToken().getString(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"name\\\"\"), \");\\n\\n    String content = String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<h1>User Page: %s (%s) @%s</h1><a href=\\\\\\\"/protected\\\\\\\">Protected Area</a>\\\"\"), \",\\n                                   username, displayName, Instant.now());\\n    respondWithOk(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", content);\\n}\\n\")), mdx(\"h3\", {\n    \"id\": \"authorization-checking-for-required-roles\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#authorization-checking-for-required-roles\"\n  })), \"Authorization: Checking for Required Roles\"), mdx(\"p\", null, \"Our app ex\\xADposes a sim\\xADple admin page which shows some in\\xADfor\\xADma\\xADtion for ad\\xADmins, which should only be vis\\xADi\\xADble for ad\\xADmins. Thus we re\\xADquire that users must have the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"admin\"), \" realm role in Key\\xADcloak to be able to ac\\xADcess the admin page.\"), mdx(\"p\", null, \"This is done via a call to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"user.isAuthorized(\\\"realm:admin\\\", cb)\"), \". The han\\xADdler func\\xADtion \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"cb\"), \" ex\\xADposes\\nthe re\\xADsult of the au\\xADtho\\xADriza\\xADtion check via the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AsyncResult<Boolean> res\"), \". If the cur\\xADrent user has the\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"admin\"), \" role then the re\\xADsult is \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"true\"), \" oth\\xADer\\xADwise \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"false\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"handleAdminPage\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n\\n    OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// check for realm-role \\\"admin\\\"\"), \"\\n    user.isAuthorized(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"realm:admin\\\"\"), \", res -> {\\n\\n        \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"if\"), \" (!res.succeeded() || !res.result()) {\\n            respondWith(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"403\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<h1>Forbidden</h1>\\\"\"), \");\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"return\"), \";\\n        }\\n\\n        String username = user.idToken().getString(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"preferred_username\\\"\"), \");\\n\\n        String content = String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<h1>Admin Page: %s @%s</h1><a href=\\\\\\\"/protected\\\\\\\">Protected Area</a>\\\"\"), \",\\n                                        username, Instant.now());\\n        respondWithOk(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", content);\\n    });\\n}\\n\")), mdx(\"h4\", {\n    \"id\": \"call-services-protected-with-bearer-token\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h4\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#call-services-protected-with-bearer-token\"\n  })), \"Call Services protected with Bearer Token\"), mdx(\"p\", null, \"Often we need to call other ser\\xADvices from our web app that are pro\\xADtected via Bearer Au\\xADthen\\xADti\\xADca\\xADtion. This means\\nthat we need a valid \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"access token\"), \" to ac\\xADcess a re\\xADsource pro\\xADvided on an\\xADother server.\"), mdx(\"p\", null, \"To demon\\xADstrate this we use Key\\xADcloak\\u2019s \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/userinfo\"), \" end\\xADpoint as a straw man to demon\\xADstrate back\\xADend calls with a bearer token.\"), mdx(\"p\", null, \"We can ob\\xADtain the cur\\xADrent valid \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"access token\"), \" via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"user.opaqueAccessToken()\"), \".\\nSince we use a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"WebClient\"), \" to call the pro\\xADtected end\\xADpoint, we need to pass the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"access token\"), \"\\nvia the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Authorization\"), \" header by call\\xADing \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"bearerTokenAuthentication(user.opaqueAccessToken())\"), \"\\nin the cur\\xADrent \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"HttpRequest\"), \" ob\\xADject:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" Handler<RoutingContext> \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"createUserInfoHandler\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(WebClient webClient, String userInfoUrl)\"), \" \"), \"{\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"return\"), \" (RoutingContext ctx) -> {\\n\\n        OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\\n\\n        URI userInfoEndpointUri = URI.create(userInfoUrl);\\n        webClient\\n            .get(userInfoEndpointUri.getPort(), userInfoEndpointUri.getHost(), userInfoEndpointUri.getPath())\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// use the access token for calls to other services protected via JWT Bearer authentication\"), \"\\n            .bearerTokenAuthentication(user.opaqueAccessToken())\\n            .as(BodyCodec.jsonObject())\\n            .send(ar -> {\\n\\n                \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"if\"), \" (!ar.succeeded()) {\\n                    respondWith(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"500\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"application/json\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"{}\\\"\"), \");\\n                    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"return\"), \";\\n                }\\n\\n                JsonObject body = ar.result().body();\\n                respondWithOk(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"application/json\\\"\"), \", body.encode());\\n            });\\n    };\\n}\\n\")), mdx(\"h3\", {\n    \"id\": \"handle-logout\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#handle-logout\"\n  })), \"Handle logout\"), mdx(\"p\", null, \"Now that we got a work\\xADing SSO login with au\\xADtho\\xADriza\\xADtion, it would be great if we would allow users to lo\\xADgout again.\\nTo do this we can lever\\xADage the built-\\u200Bin OpenID Con\\xADnect lo\\xADgout func\\xADtion\\xADal\\xADity which can be called via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"oAuth2Token.logout(cb)\"), \".\"), mdx(\"p\", null, \"The han\\xADdler func\\xADtion \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"cb\"), \" ex\\xADposes the re\\xADsult of the lo\\xADgout ac\\xADtion via the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AsyncResult<Void> res\"), \".\\nIf the lo\\xADgout was suc\\xADcess\\xADfull we destory our ses\\xADsion via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ctx.session().destroy()\"), \" and redi\\xADrect the user to the index page.\"), mdx(\"p\", null, \"The lo\\xADgout form is gen\\xADer\\xADated via the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"createLogoutForm\"), \" method.\"), mdx(\"p\", null, \"As men\\xADtioned ear\\xADlier, we need to pro\\xADtect our lo\\xADgout form with a CSRF token to pre\\xADvent \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://owasp.org/www-community/attacks/csrf\"\n  }), \"CSRF at\\xADtacks\"), \".\"), mdx(\"p\", null, \"Note: If we had end\\xADpoints that would ac\\xADcept data sent to the server, then we\\u2019d need to guard those end\\xADpoints with an CSRF token as well.\"), mdx(\"p\", null, \"We need to ob\\xADtain the gen\\xADer\\xADated \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CSRFToken\"), \" and ren\\xADder it into a hid\\xADden form input field that\\u2019s trans\\xADfered via HTTP POST when the lo\\xADgout form is sub\\xADmit\\xADted:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"handleLogout\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n\\n    OAuth2TokenImpl oAuth2Token = (OAuth2TokenImpl) ctx.user();\\n    oAuth2Token.logout(res -> {\\n\\n        \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"if\"), \" (!res.succeeded()) {\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// the user might not have been logged out, to know why:\"), \"\\n            respondWith(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"500\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<h1>Logout failed %s</h1>\\\"\"), \", res.cause()));\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"return\"), \";\\n        }\\n\\n        ctx.session().destroy();\\n        ctx.response().putHeader(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"location\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/?logout=true\\\"\"), \").setStatusCode(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"302\"), \").end();\\n    });\\n}\\n\\n\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" String \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"createLogoutForm\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n\\n    String csrfToken = ctx.get(CSRFHandler.DEFAULT_HEADER_NAME);\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"return\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<form action=\\\\\\\"/logout\\\\\\\" method=\\\\\\\"post\\\\\\\">\\\"\"), \"\\n            + String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<input type=\\\\\\\"hidden\\\\\\\" name=\\\\\\\"%s\\\\\\\" value=\\\\\\\"%s\\\\\\\">\\\"\"), \", CSRFHandler.DEFAULT_HEADER_NAME, csrfToken)\\n            + \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"<button>Logout</button></form>\\\"\"), \";\\n}\\n\")), mdx(\"p\", null, \"Some ad\\xADdi\\xADtional plumb\\xADing:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"respondWithOk\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx, String contentType, String content)\"), \" \"), \"{\\n    respondWith(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"200\"), \", contentType, content);\\n}\\n\\n\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"respondWith\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx, \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"int\"), \" statusCode, String contentType, String content)\"), \" \"), \"{\\n    ctx.request().response() \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"//\"), \"\\n            .putHeader(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"content-type\\\"\"), \", contentType) \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"//\"), \"\\n            .setStatusCode(statusCode)\\n            .end(content);\\n}\\n\")), mdx(\"h2\", {\n    \"id\": \"more-examples\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#more-examples\"\n  })), \"More examples\"), mdx(\"p\", null, \"This con\\xADcludes the Key\\xADcloak in\\xADte\\xADgra\\xADtion ex\\xADam\\xADple.\"), mdx(\"p\", null, \"Check out the com\\xADplete ex\\xADam\\xADple in \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/thomasdarimont/vertx-playground/tree/master/keycloak-vertx\"\n  }), \"keycloak-\\u200Bvertx Ex\\xADam\\xADples Repo\"), \".\"), mdx(\"p\", null, \"Thank you for your time, stay tuned for more up\\xADdates! If you want to learn more about Key\\xADcloak, feel free to reach out to me. You can find me via \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://twitter.com/thomasdarimont\"\n  }), \"thomas\\xADda\\xADri\\xADmont on twit\\xADter\"), \".\"), mdx(\"p\", null, \"Happy Hack\\xADing!\"));\n}\n\n;\nMDXContent.isMDXComponent = true;","renderedOutput":"<p><strong>TL;DR:</strong></p><p>In this blog post youll learn:</p><ul><li>How to implement Single Sign-on with OpenID Connect</li><li>How to use Keycloaks OpenID Discovery to infer OpenID provider configuration</li><li>How to obtain user information</li><li>How to check for authorization</li><li>How to call a Bearer protected service with an Access Token</li><li>How to implement a form based logout</li></ul><h2 id=\"hello-blog\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#hello-blog\"></a>Hello Blog</h2><p>This is my first post in the Vert.x Blog and I must admit that up until now I have never used Vert.x in a real project.\nWhy are you here?, you might ask Well I currently have two main hobbies, learning new things and securing apps with <a href=\"https://www.keycloak.org/\">Keycloak</a>.\nSo a few days ago, I stumbled upon the <a href=\"https://www.youtube.com/watch?v=LsaXy7SRXMY&amp;list=PLkeCJDaCC2ZsnySdg04Aq9D9FpAZY6K5D\">Introduction to Vert.x video series on youtube</a> by <a href=\"https://twitter.com/infosec812\">Deven Phillips</a> and I was immediately hooked. Vert.x was a new thing for me, so the next logical step was to figure out how to secure a Vert.x app with Keycloak.</p><p>For this example I build a small web app with Vert.x that shows how to implement Single Sign-on (SSO) with Keycloak\nand OpenID Connect, obtain information about the current user, check for roles, call bearer protected services and properly handling logout.</p><h2 id=\"keycloak\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#keycloak\"></a>Keycloak</h2><p><a href=\"https://www.keycloak.org/\">Keycloak</a> is a Open Source Identity and Access Management solution which provides support for OpenID Connect\nbased Singe-Sign on, among many other things. I briefly looked for ways to securing a Vert.x app with Keycloak\nand quickly found an <a href=\"/blog/vertx-3-and-keycloak-tutorial/\">older Vert.x Keycloak integration example</a> in this very blog.\nWhilst this is a good start for beginners, the example contains a few issues, e.g.:</p><ul><li>It uses hardcoded OpenID provider configuration</li><li>Features a very simplistic integration (for the sake of simplicity)</li><li>No user information used</li><li>No logout functionality is shown</li></ul><p>That somehow nerdsniped me a bit and so it came that, after a long day of consulting work, I sat down to create an example for a complete Keycloak integration based on <a href=\"/docs/vertx-auth-oauth2/java/\">Vert.x OpenID Connect / OAuth2 Support</a>.</p><p>So lets get started!</p><h3 id=\"keycloak-setup\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#keycloak-setup\"></a>Keycloak Setup</h3><p>To secure a Vert.x app with Keycloak we of course need a Keycloak instance. Although <a href=\"https://www.keycloak.org/docs/latest/getting_started/\">Keycloak has a great getting started guide</a> I wanted to make it a bit easier to put everything together, therefore I prepared a local Keycloak docker container <a href=\"https://github.com/thomasdarimont/vertx-playground/tree/master/keycloak-vertx#start-keycloak-with-the-vertx-realm\">as described here</a> that you can start easily, which comes with all the required configuration in place.</p><p>The preconfigured Keycloak realm named <code>vertx</code> contains a <code>demo-client</code> for our Vert.x web app and a set\nof users for testing.</p><pre><code class=\"hljs language-haml\">docker run \\\n  -<span class=\"ruby\">it \\\n</span>  -<span class=\"ruby\">-name vertx-keycloak \\\n</span>  -<span class=\"ruby\">-rm \\\n</span>  -<span class=\"ruby\">e KEYCLOAK_USER=admin \\\n</span>  -<span class=\"ruby\">e KEYCLOAK_PASSWORD=admin \\\n</span>  -<span class=\"ruby\">e KEYCLOAK_IMPORT=<span class=\"hljs-regexp\">/tmp/vertx</span>-realm.json \\\n</span>  -<span class=\"ruby\">v $PWD/vertx-realm.<span class=\"hljs-symbol\">json:</span>/tmp/vertx-realm.json \\\n</span>  -<span class=\"ruby\">p <span class=\"hljs-number\">8080</span><span class=\"hljs-symbol\">:</span><span class=\"hljs-number\">8080</span> \\\n</span>  quay.io/keycloak/keycloak:9.0.0\n</code></pre><h2 id=\"vertx-web-app\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#vertx-web-app\"></a>Vert.x Web App</h2><p>The simple web app consists of a single <code>Verticle</code>, runs on <code>http://localhost:8090</code> and provides a few routes with protected resources. <a href=\"https://github.com/thomasdarimont/vertx-playground/blob/master/keycloak-vertx/src/main/java/demo/MainVerticle.java\">You can find the complete example here</a>.</p><p>The web app contains the following routes with handlers:</p><ul><li><code>/</code> - The unprotected index page</li><li><code>/protected</code> - The protected page, which shows a greeting message, users need to login to access pages beneath this path.</li><li><code>/protected/user</code> - The protected user page, which shows some information about the user.</li><li><code>/protected/admin</code> - The protected admin page, which shows some information about the admin, only users with role <code>admin</code> can access this page.</li><li><code>/protected/userinfo</code> - The protected userinfo page, obtains user information from the bearer token protected userinfo endpoint in Keycloak.</li><li><code>/logout</code> - The protected logout resource, which triggers the user logout.</li></ul><h3 id=\"running-the-app\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#running-the-app\"></a>Running the app</h3><p>To run the app, we need to build our app via:</p><pre><code class=\"hljs language-bash\"><span class=\"hljs-built_in\">cd</span> keycloak-vertx\nmvn clean package\n</code></pre><p>This creates a runnable jar, which we can run via:</p><pre><code class=\"hljs language-bash\">java -jar target/*.jar\n</code></pre><p>Note, that you need to start Keycloak, since our app will try to fetch configuration from Keycloak.</p><p>If the application is running, just browse to: <code>http://localhost:8090/</code>.</p><p>An example interaction with the app can be seen in the following gif:</p><p><img src=\"/images/blog/vertx-keycloak-integration/2020-03-07-vertx-keycloak-integration.gif\" alt=\"Vert.x Keycloak Integration Demo\"/></p><h3 id=\"router-sessionstore-and-csrf-protection\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#router-sessionstore-and-csrf-protection\"></a>Router, SessionStore and CSRF Protection</h3><p>We start the configuration of our web app by creating a <code>Router</code> where we can add custom handler functions for our routes.\nTo properly handle the authentication state we need to create a <code>SessionStore</code> and attach it to the <code>Router</code>.\nThe <code>SessionStore</code> is used by our OAuth2/OpenID Connect infrastructure to associate authentication information with a session.\nBy the way, the <code>SessionStore</code> can also be clustered if you need to distribute the server-side state.</p><p>Note that if you want to keep your server stateless but still want to support clustering,\nthen you could provide your own implementation of a <code>SessionStore</code> which stores the session information\nas an encrypted cookie on the Client.</p><pre><code class=\"hljs language-java\">Router router = Router.router(vertx);\n\n<span class=\"hljs-comment\">// Store session information on the server side</span>\nSessionStore sessionStore = LocalSessionStore.create(vertx);\nSessionHandler sessionHandler = SessionHandler.create(sessionStore);\nrouter.route().handler(sessionHandler);\n</code></pre><p>In order to protected against CSRF attacks it is good practice to protect HTML forms with a CSRF token.\nWe need this for our logout form that well see later.</p><p>To do this we configure a <code>CSRFHandler</code> and add it to our <code>Router</code>:</p><pre><code class=\"hljs language-java\"><span class=\"hljs-comment\">// CSRF handler setup required for logout form</span>\nString csrfSecret = <span class=\"hljs-string\">&quot;zwiebelfische&quot;</span>;\nCSRFHandler csrfHandler = CSRFHandler.create(csrfSecret);\nrouter.route().handler(ctx -&gt; {\n            <span class=\"hljs-comment\">// Ensures that the csrf token request parameter is available for the CsrfHandler</span>\n            <span class=\"hljs-comment\">// after the logout form was submitted.</span>\n            <span class=\"hljs-comment\">// See &quot;Handling HTML forms&quot; https://vertx.io/docs/vertx-core/java/#_handling_requests</span>\n            ctx.request().setExpectMultipart(<span class=\"hljs-keyword\">true</span>);\n            ctx.request().endHandler(v -&gt; csrfHandler.handle(ctx));\n        }\n);\n</code></pre><h3 id=\"keycloak-setup-via-openid-connect-discovery\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#keycloak-setup-via-openid-connect-discovery\"></a>Keycloak Setup via OpenID Connect Discovery</h3><p>Our app is registered as a confidential OpenID Connect client with Authorization Code Flow in Keycloak,\nthus we need to configure <code>client_id</code> and <code>client_secret</code>. Confidential clients are typically used\nfor server-side web applications, where one can securely store the <code>client_secret</code>. You can find out more\nabout<a href=\"https://www.keycloak.org/docs/latest/server_admin/index.html#_access-type\">The different Client Access Types</a> in the Keycloak documentation.</p><p>Since we dont want to configure things like OAuth2 / OpenID Connect Endpoints ourselves, we use Keycloaks OpenID Connect discovery endpoint to infer the necessary Oauth2 / OpenID Connect endpoint URLs.</p><pre><code class=\"hljs language-java\">String hostname = System.getProperty(<span class=\"hljs-string\">&quot;http.host&quot;</span>, <span class=\"hljs-string\">&quot;localhost&quot;</span>);\n<span class=\"hljs-keyword\">int</span> port = Integer.getInteger(<span class=\"hljs-string\">&quot;http.port&quot;</span>, <span class=\"hljs-number\">8090</span>);\nString baseUrl = String.format(<span class=\"hljs-string\">&quot;http://%s:%d&quot;</span>, hostname, port);\nString oauthCallbackPath = <span class=\"hljs-string\">&quot;/callback&quot;</span>;\n\nOAuth2ClientOptions clientOptions = <span class=\"hljs-keyword\">new</span> OAuth2ClientOptions()\n    .setFlow(OAuth2FlowType.AUTH_CODE)\n    .setSite(System.getProperty(<span class=\"hljs-string\">&quot;oauth2.issuer&quot;</span>, <span class=\"hljs-string\">&quot;http://localhost:8080/auth/realms/vertx&quot;</span>))\n    .setClientID(System.getProperty(<span class=\"hljs-string\">&quot;oauth2.client_id&quot;</span>, <span class=\"hljs-string\">&quot;demo-client&quot;</span>))\n    .setClientSecret(System.getProperty(<span class=\"hljs-string\">&quot;oauth2.client_secret&quot;</span>, <span class=\"hljs-string\">&quot;1f88bd14-7e7f-45e7-be27-d680da6e48d8&quot;</span>));\n\nKeycloakAuth.discover(vertx, clientOptions, asyncResult -&gt; {\n\n    OAuth2Auth oauth2Auth = asyncResult.result();\n\n    <span class=\"hljs-keyword\">if</span> (oauth2Auth == <span class=\"hljs-keyword\">null</span>) {\n        <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> RuntimeException(<span class=\"hljs-string\">&quot;Could not configure Keycloak integration via OpenID Connect Discovery Endpoint. Is Keycloak running?&quot;</span>);\n    }\n\n    AuthHandler oauth2 = OAuth2AuthHandler.create(oauth2Auth, baseUrl + oauthCallbackPath)\n        .setupCallback(router.get(oauthCallbackPath))\n        <span class=\"hljs-comment\">// Additional scopes: openid for OpenID Connect</span>\n        .addAuthority(<span class=\"hljs-string\">&quot;openid&quot;</span>);\n\n    <span class=\"hljs-comment\">// session handler needs access to the authenticated user, otherwise we get an infinite redirect loop</span>\n    sessionHandler.setAuthProvider(oauth2Auth);\n\n    <span class=\"hljs-comment\">// protect resources beneath /protected/* with oauth2 handler</span>\n    router.route(<span class=\"hljs-string\">&quot;/protected/*&quot;</span>).handler(oauth2);\n\n    <span class=\"hljs-comment\">// configure route handlers</span>\n    configureRoutes(router, webClient, oauth2Auth);\n});\n\ngetVertx().createHttpServer().requestHandler(router).listen(port);\n</code></pre><h3 id=\"route-handlers\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#route-handlers\"></a>Route handlers</h3><p>We configure our route handlers via <code>configureRoutes</code>:</p><pre><code class=\"hljs language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">configureRoutes</span><span class=\"hljs-params\">(Router router, WebClient webClient, OAuth2Auth oauth2Auth)</span> </span>{\n\n    router.get(<span class=\"hljs-string\">&quot;/&quot;</span>).handler(<span class=\"hljs-keyword\">this</span>::handleIndex);\n\n    router.get(<span class=\"hljs-string\">&quot;/protected&quot;</span>).handler(<span class=\"hljs-keyword\">this</span>::handleGreet);\n    router.get(<span class=\"hljs-string\">&quot;/protected/user&quot;</span>).handler(<span class=\"hljs-keyword\">this</span>::handleUserPage);\n    router.get(<span class=\"hljs-string\">&quot;/protected/admin&quot;</span>).handler(<span class=\"hljs-keyword\">this</span>::handleAdminPage);\n\n    <span class=\"hljs-comment\">// extract discovered userinfo endpoint url</span>\n    String userInfoUrl =  ((OAuth2AuthProviderImpl)oauth2Auth).getConfig().getUserInfoPath();\n    router.get(<span class=\"hljs-string\">&quot;/protected/userinfo&quot;</span>).handler(createUserInfoHandler(webClient, userInfoUrl));\n\n    router.post(<span class=\"hljs-string\">&quot;/logout&quot;</span>).handler(<span class=\"hljs-keyword\">this</span>::handleLogout);\n}\n</code></pre><p>The index handler exposes an unprotected resource:</p><pre><code class=\"hljs language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">handleIndex</span><span class=\"hljs-params\">(RoutingContext ctx)</span> </span>{\n    respondWithOk(ctx, <span class=\"hljs-string\">&quot;text/html&quot;</span>, <span class=\"hljs-string\">&quot;&lt;h1&gt;Welcome to Vert.x Keycloak Example&lt;/h1&gt;&lt;br&gt;&lt;a href=\\&quot;/protected\\&quot;&gt;Protected&lt;/a&gt;&quot;</span>);\n}\n</code></pre><h3 id=\"extract-user-information-from-the-openid-connect-id-token\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#extract-user-information-from-the-openid-connect-id-token\"></a>Extract User Information from the OpenID Connect ID Token</h3><p>Our app exposes a simple greeting page which shows some information about the user and provides links to other pages.</p><p>The user greeting handler is protected by the Keycloak OAuth2 / OpenID Connect integration. To show information about\nthe current user, we first need to call the <code>ctx.user()</code> method to get an user object we can work with.\nTo access the OAuth2 token information, we need to cast it to <code>OAuth2TokenImpl</code>.</p><p>We can extract the user information like the username from the <code>IDToken</code> exposed by the user object via <code>user.idToken().getString(&quot;preferred_username&quot;)</code>.\nNote, there are many more claims like (name, email, givenanme, familyname etc.) available. The <a href=\"https://openid.net/specs/openid-connect-core-1_0.html#Claims\">OpenID Connect Core Specification</a> contains a list of available claims.</p><p>We also generate a list with links to the other pages which are supported:</p><pre><code class=\"hljs language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">handleGreet</span><span class=\"hljs-params\">(RoutingContext ctx)</span> </span>{\n\n    OAuth2TokenImpl oAuth2Token = (OAuth2TokenImpl) ctx.user();\n\n    String username = oAuth2Token.idToken().getString(<span class=\"hljs-string\">&quot;preferred_username&quot;</span>);\n\n    String greeting = String.format(<span class=\"hljs-string\">&quot;&lt;h1&gt;Hi %s @%s&lt;/h1&gt;&lt;ul&gt;&quot;</span> +\n            <span class=\"hljs-string\">&quot;&lt;li&gt;&lt;a href=\\&quot;/protected/user\\&quot;&gt;User Area&lt;/a&gt;&lt;/li&gt;&quot;</span> +\n            <span class=\"hljs-string\">&quot;&lt;li&gt;&lt;a href=\\&quot;/protected/admin\\&quot;&gt;Admin Area&lt;/a&gt;&lt;/li&gt;&quot;</span> +\n            <span class=\"hljs-string\">&quot;&lt;li&gt;&lt;a href=\\&quot;/protected/userinfo\\&quot;&gt;User Info (Remote Call)&lt;/a&gt;&lt;/li&gt;&quot;</span> +\n            <span class=\"hljs-string\">&quot;&lt;/ul&gt;&quot;</span>, username, Instant.now());\n\n    String logoutForm = createLogoutForm(ctx);\n\n    respondWithOk(ctx, <span class=\"hljs-string\">&quot;text/html&quot;</span>, greeting + logoutForm);\n}\n</code></pre><p>The user page handler shows information about the current user:</p><pre><code class=\"hljs language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">handleUserPage</span><span class=\"hljs-params\">(RoutingContext ctx)</span> </span>{\n\n    OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\n\n    String username = user.idToken().getString(<span class=\"hljs-string\">&quot;preferred_username&quot;</span>);\n    String displayName = oAuth2Token.idToken().getString(<span class=\"hljs-string\">&quot;name&quot;</span>);\n\n    String content = String.format(<span class=\"hljs-string\">&quot;&lt;h1&gt;User Page: %s (%s) @%s&lt;/h1&gt;&lt;a href=\\&quot;/protected\\&quot;&gt;Protected Area&lt;/a&gt;&quot;</span>,\n                                   username, displayName, Instant.now());\n    respondWithOk(ctx, <span class=\"hljs-string\">&quot;text/html&quot;</span>, content);\n}\n</code></pre><h3 id=\"authorization-checking-for-required-roles\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#authorization-checking-for-required-roles\"></a>Authorization: Checking for Required Roles</h3><p>Our app exposes a simple admin page which shows some information for admins, which should only be visible for admins. Thus we require that users must have the <code>admin</code> realm role in Keycloak to be able to access the admin page.</p><p>This is done via a call to <code>user.isAuthorized(&quot;realm:admin&quot;, cb)</code>. The handler function <code>cb</code> exposes\nthe result of the authorization check via the <code>AsyncResult&lt;Boolean&gt; res</code>. If the current user has the\n<code>admin</code> role then the result is <code>true</code> otherwise <code>false</code>:</p><pre><code class=\"hljs language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">handleAdminPage</span><span class=\"hljs-params\">(RoutingContext ctx)</span> </span>{\n\n    OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\n\n    <span class=\"hljs-comment\">// check for realm-role &quot;admin&quot;</span>\n    user.isAuthorized(<span class=\"hljs-string\">&quot;realm:admin&quot;</span>, res -&gt; {\n\n        <span class=\"hljs-keyword\">if</span> (!res.succeeded() || !res.result()) {\n            respondWith(ctx, <span class=\"hljs-number\">403</span>, <span class=\"hljs-string\">&quot;text/html&quot;</span>, <span class=\"hljs-string\">&quot;&lt;h1&gt;Forbidden&lt;/h1&gt;&quot;</span>);\n            <span class=\"hljs-keyword\">return</span>;\n        }\n\n        String username = user.idToken().getString(<span class=\"hljs-string\">&quot;preferred_username&quot;</span>);\n\n        String content = String.format(<span class=\"hljs-string\">&quot;&lt;h1&gt;Admin Page: %s @%s&lt;/h1&gt;&lt;a href=\\&quot;/protected\\&quot;&gt;Protected Area&lt;/a&gt;&quot;</span>,\n                                        username, Instant.now());\n        respondWithOk(ctx, <span class=\"hljs-string\">&quot;text/html&quot;</span>, content);\n    });\n}\n</code></pre><h4 id=\"call-services-protected-with-bearer-token\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#call-services-protected-with-bearer-token\"></a>Call Services protected with Bearer Token</h4><p>Often we need to call other services from our web app that are protected via Bearer Authentication. This means\nthat we need a valid <code>access token</code> to access a resource provided on another server.</p><p>To demonstrate this we use Keycloaks <code>/userinfo</code> endpoint as a straw man to demonstrate backend calls with a bearer token.</p><p>We can obtain the current valid <code>access token</code> via <code>user.opaqueAccessToken()</code>.\nSince we use a <code>WebClient</code> to call the protected endpoint, we need to pass the <code>access token</code>\nvia the <code>Authorization</code> header by calling <code>bearerTokenAuthentication(user.opaqueAccessToken())</code>\nin the current <code>HttpRequest</code> object:</p><pre><code class=\"hljs language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Handler&lt;RoutingContext&gt; <span class=\"hljs-title\">createUserInfoHandler</span><span class=\"hljs-params\">(WebClient webClient, String userInfoUrl)</span> </span>{\n\n    <span class=\"hljs-keyword\">return</span> (RoutingContext ctx) -&gt; {\n\n        OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\n\n        URI userInfoEndpointUri = URI.create(userInfoUrl);\n        webClient\n            .get(userInfoEndpointUri.getPort(), userInfoEndpointUri.getHost(), userInfoEndpointUri.getPath())\n            <span class=\"hljs-comment\">// use the access token for calls to other services protected via JWT Bearer authentication</span>\n            .bearerTokenAuthentication(user.opaqueAccessToken())\n            .as(BodyCodec.jsonObject())\n            .send(ar -&gt; {\n\n                <span class=\"hljs-keyword\">if</span> (!ar.succeeded()) {\n                    respondWith(ctx, <span class=\"hljs-number\">500</span>, <span class=\"hljs-string\">&quot;application/json&quot;</span>, <span class=\"hljs-string\">&quot;{}&quot;</span>);\n                    <span class=\"hljs-keyword\">return</span>;\n                }\n\n                JsonObject body = ar.result().body();\n                respondWithOk(ctx, <span class=\"hljs-string\">&quot;application/json&quot;</span>, body.encode());\n            });\n    };\n}\n</code></pre><h3 id=\"handle-logout\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#handle-logout\"></a>Handle logout</h3><p>Now that we got a working SSO login with authorization, it would be great if we would allow users to logout again.\nTo do this we can leverage the built-in OpenID Connect logout functionality which can be called via <code>oAuth2Token.logout(cb)</code>.</p><p>The handler function <code>cb</code> exposes the result of the logout action via the <code>AsyncResult&lt;Void&gt; res</code>.\nIf the logout was successfull we destory our session via <code>ctx.session().destroy()</code> and redirect the user to the index page.</p><p>The logout form is generated via the <code>createLogoutForm</code> method.</p><p>As mentioned earlier, we need to protect our logout form with a CSRF token to prevent <a href=\"https://owasp.org/www-community/attacks/csrf\">CSRF attacks</a>.</p><p>Note: If we had endpoints that would accept data sent to the server, then wed need to guard those endpoints with an CSRF token as well.</p><p>We need to obtain the generated <code>CSRFToken</code> and render it into a hidden form input field thats transfered via HTTP POST when the logout form is submitted:</p><pre><code class=\"hljs language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">handleLogout</span><span class=\"hljs-params\">(RoutingContext ctx)</span> </span>{\n\n    OAuth2TokenImpl oAuth2Token = (OAuth2TokenImpl) ctx.user();\n    oAuth2Token.logout(res -&gt; {\n\n        <span class=\"hljs-keyword\">if</span> (!res.succeeded()) {\n            <span class=\"hljs-comment\">// the user might not have been logged out, to know why:</span>\n            respondWith(ctx, <span class=\"hljs-number\">500</span>, <span class=\"hljs-string\">&quot;text/html&quot;</span>, String.format(<span class=\"hljs-string\">&quot;&lt;h1&gt;Logout failed %s&lt;/h1&gt;&quot;</span>, res.cause()));\n            <span class=\"hljs-keyword\">return</span>;\n        }\n\n        ctx.session().destroy();\n        ctx.response().putHeader(<span class=\"hljs-string\">&quot;location&quot;</span>, <span class=\"hljs-string\">&quot;/?logout=true&quot;</span>).setStatusCode(<span class=\"hljs-number\">302</span>).end();\n    });\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> String <span class=\"hljs-title\">createLogoutForm</span><span class=\"hljs-params\">(RoutingContext ctx)</span> </span>{\n\n    String csrfToken = ctx.get(CSRFHandler.DEFAULT_HEADER_NAME);\n\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;&lt;form action=\\&quot;/logout\\&quot; method=\\&quot;post\\&quot;&gt;&quot;</span>\n            + String.format(<span class=\"hljs-string\">&quot;&lt;input type=\\&quot;hidden\\&quot; name=\\&quot;%s\\&quot; value=\\&quot;%s\\&quot;&gt;&quot;</span>, CSRFHandler.DEFAULT_HEADER_NAME, csrfToken)\n            + <span class=\"hljs-string\">&quot;&lt;button&gt;Logout&lt;/button&gt;&lt;/form&gt;&quot;</span>;\n}\n</code></pre><p>Some additional plumbing:</p><pre><code class=\"hljs language-java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">respondWithOk</span><span class=\"hljs-params\">(RoutingContext ctx, String contentType, String content)</span> </span>{\n    respondWith(ctx, <span class=\"hljs-number\">200</span>, contentType, content);\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">respondWith</span><span class=\"hljs-params\">(RoutingContext ctx, <span class=\"hljs-keyword\">int</span> statusCode, String contentType, String content)</span> </span>{\n    ctx.request().response() <span class=\"hljs-comment\">//</span>\n            .putHeader(<span class=\"hljs-string\">&quot;content-type&quot;</span>, contentType) <span class=\"hljs-comment\">//</span>\n            .setStatusCode(statusCode)\n            .end(content);\n}\n</code></pre><h2 id=\"more-examples\"><a aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#more-examples\"></a>More examples</h2><p>This concludes the Keycloak integration example.</p><p>Check out the complete example in <a href=\"https://github.com/thomasdarimont/vertx-playground/tree/master/keycloak-vertx\">keycloak-vertx Examples Repo</a>.</p><p>Thank you for your time, stay tuned for more updates! If you want to learn more about Keycloak, feel free to reach out to me. You can find me via <a href=\"https://twitter.com/thomasdarimont\">thomasdarimont on twitter</a>.</p><p>Happy Hacking!</p>","scope":{}}},"prevPost":{"meta":{"title":"Eclipse Vert.x 3.9.0 released!","category":"releases","authors":[{"name":"Julien Viet","github_id":"vietj"}],"summary":"New features include fluent queries in SQL clients, a new Redis client, an updated Kafka client, an improved Future API, and many more things."},"date":"2020-04-02","slug":"eclipse-vert-x-3-9-0-released"},"nextPost":{"meta":{"title":"Eclipse Vert.x 3.8.5","category":"releases","authors":[{"name":"Julien Viet","github_id":"vietj"}],"summary":"This version is a minor bug fix release addressing issues found in Vert.x 3.8.4. We would like to thank you all for reporting these issues."},"date":"2020-01-24","slug":"eclipse-vert-x-3-8-5"},"relatedPosts":[{"meta":{"title":"JWT Authorization for Vert.x with Keycloak","category":"guides","authors":[{"name":"Thomas Darimont","github_id":"thomasdarimont"}],"summary":"In this blog post, you'll learn about JWT foundations, protect routes with JWT Authorization, JWT encoded tokens, and RBAC with Keycloak"},"date":"2020-10-01","slug":"jwt-authorization-for-vert-x-with-keycloak"},{"meta":{"title":"Some Rest with Vert.x","category":"guides","authors":[{"name":"Clement Escoffier","github_id":"cescoffier"}],"summary":"This post is part of the Introduction to Vert.x series. Lets go a bit further this time and develop a CRUD-ish application"},"date":"2015-07-27","slug":"some-rest-with-vert-x"},{"meta":{"title":"Real-time bidding with Websockets and Vert.x","category":"guides","authors":[{"name":"Marcin Warczyglowa","github_id":"mwarc"}],"summary":"The expectations of users for interactivity with web applications have changed over the past few years.\n    Users during bidding in auction no longer want to press the refresh button."},"date":"2016-01-15","slug":"real-time-bidding-with-websockets-and-vert-x"}]},"__N_SSG":true}